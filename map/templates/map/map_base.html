{% extends 'app1/base.html' %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Соловецкие острова</title>
    <!-- Подключаем Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Подключаем Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Убираем полосу прокрутки у body */
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
        }
        #info-panel {
            position: absolute;
            top: 0;
            bottom: 0;
            right: -33%; /* Скрываем панель за пределами экрана */
            width: 30%;
            background: #ffffff;
            overflow-y: auto;
            padding: 10px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.5s ease-in-out;
        }
        #info-panel.visible {
            right: 0; /* Показываем панель */
        }
        #info-panel h2 {
            color: #000000;
        }
        #info-content {
            color: #000000;
            font-style: unset;
        }
        #info-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        h1 {
            position: absolute;
            top: 10px;
            left: 10px;
            margin: 0;
            padding: 10px;
            color: #fff;
            background: rgb(255, 255, 255);
        }
        #h2 {
            color: white;
        }
        .leaflet-control-attribution {
            display: none;
        }
        .custom-icon {
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.3s;
        }
        .custom-icon:hover {
            transform: translateY(-10px);
        }
        #hide-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        #hide-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .zoom-control {
            position: absolute;
            top: 10px;
            left: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .zoom-control:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .zoom-control i {
            font-size: 1.5rem;
        }


        #locations-button {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s;
            z-index: 1005;
        }
        #locations-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #locations-button i {
            font-size: 1.5rem;
        }
        #locations-panel {
            position: absolute;
            top: 0;
            bottom: 0;
            left: -100%; /* Скрываем панель за пределами экрана */
            width: 30%;
            background: rgb(255, 255, 255);
            border-radius: 0 5px 5px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            transition: left 0.5s ease-in-out;
            z-index: 1004;
        }
        #locations-panel.visible {
            left: 0; /* Показываем панель */
        }
        #locations-panel h3 {
            margin-top: 0;
            color: #000000;
        }
        #locations-panel ul {
            list-style-type: none;
            padding: 0;
        }
        #locations-panel ul li {
            padding: 10px 0;
            border-bottom: 1px solid #000000;
            transition: color 0.3s, transform 0.3s;
        }
        #locations-panel ul li:hover {
            color: rgb(192, 7, 7);
            transform: translateX(10px);
            cursor: pointer;
        }
        #locations-panel ul li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <button id="hide-button">Скрыть</button>
        <div id="info-content"></div>
    </div>
    <div class="zoom-control" id="zoom-in">
        <i class="fas fa-search-plus"></i>
    </div>
    <div class="zoom-control" id="zoom-out">
        <i class="fas fa-search-minus"></i>
    </div>
    <div id="locations-button">
        <i class="fas fa-chevron-right"></i>
    </div>
    <div id="locations-panel">
        <h3>Список мест</h3>
        <ul id="locations-list">
            <!-- Список мест будет добавлен сюда -->
        </ul>
    </div>

    <!-- Подключаем Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Инициализация карты
        var map = L.map('map').setView([65.0167, 35.7167], 10); // Начальная позиция карты

        // Добавление слоя OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Функция для получения данных с backend
        async function fetchData() {
            try {
                const response = await fetch('http://127.0.0.1:8000/map/api/map/'); // URL вашего API
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new TypeError("Oops, we haven't got JSON!");
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Ошибка при получении данных:', error);
                return [];
            }
        }

        var markers = L.markerClusterGroup();

        function addDataToMap(data) {
            data.forEach(point => {
                // Используем поля latitude и longitude из данных
                const lat = point.latitude;
                const lng = point.longitude;

                // Создание кастомного маркера
                var customIcon = L.divIcon({
                    className: 'custom-icon',
                    html: `<img src="${point.icons}" alt="Icon" width="30" height="30">`,
                    iconSize: [30, 30]
                });

                var marker = L.marker([lat, lng], { icon: customIcon }).on('click', function() {
                    // Обновление содержимого панели информации
                    document.getElementById('info-content').innerHTML = `
                        <h2>${point.name}</h2>
                        <p>${point.history}</p>
                        <img src="${point.photos}" alt="Photo">
                    `;
                    // Отображение панели информации
                    document.getElementById('info-panel').classList.add('visible');
                });

                // Добавление маркера в группу кластеризации
                markers.addLayer(marker);

                // Добавление элемента в список мест
                const listItem = document.createElement('li');
                listItem.textContent = point.name;
                listItem.addEventListener('click', function() {
                    marker.openPopup();
                    map.setView([lat, lng], 14);
                    document.getElementById('locations-panel').classList.remove('visible');
                });
                document.getElementById('locations-list').appendChild(listItem);
            });

            // Добавление группы маркеров на карту
            map.addLayer(markers);
        }

        // Получение данных и добавление их на карту
        fetchData().then(data => {
            addDataToMap(data);
        });

        // Обработчик событий для карты, чтобы скрывать панель при клике на карту
        map.on('click', function() {
            document.getElementById('info-panel').classList.remove('visible');
            document.getElementById('locations-panel').classList.remove('visible');
        });

        // Обработчик событий для кнопки скрытия панели
        document.getElementById('hide-button').addEventListener('click', function() {
            document.getElementById('info-panel').classList.remove('visible');
        });

        // Обработчики событий для кнопок увеличения и уменьшения масштаба
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });

        // Обработчик событий для кнопки отображения списка мест
        document.getElementById('locations-button').addEventListener('click', function() {
            const locationsPanel = document.getElementById('locations-panel');
            if (locationsPanel.classList.contains('visible')) {
                locationsPanel.classList.remove('visible');
            } else {
                locationsPanel.classList.add('visible');
            }
        });
    </script>
</body>
</html>

</body>
{% endblock %}